CREATE VIEW  business_intelligence.search_interactions_base AS
SELECT 			public.offer_search_v1.search_id,
				public.offer_search_v1.guest_id,
				public.offer_search_v1.tracking_id,
				public.upl_touches_v1.device,
				public.upl_touches_v1.device_model,
				public.offer_search_v1.country,
				public.offer_search_v1.city,
				public.offer_search_v1.sort_by,
				DATE(TIMESTAMP 'epoch' + public.offer_search_v1.created_at/1000 * INTERVAL '1 second') as searched_at,
				public.offer_search_v1.experiment_id,
				COUNT(DISTINCT(public.offer_search_results_v1.offer_id)) as nbr_results,
				COUNT(DISTINCT(public.offer_search_click_v1.offer_id)) as nbr_offers_clicked
FROM 	 		public.offer_search_v1
LEFT JOIN		public.upl_touches_v1
					ON public.upl_touches_v1.tracking_id =  public.offer_search_v1.tracking_id
LEFT JOIN		public.offer_search_results_v1
					ON public.offer_search_results_v1.search_id =  public.offer_search_v1.search_id
LEFT JOIN		public.offer_search_click_v1
	 				ON public.offer_search_click_v1.search_id = public.offer_search_v1.search_id 
WHERE	 		DATE(TIMESTAMP 'epoch' + public.offer_search_v1.created_at/1000 * INTERVAL '1 second') >= '2018-09-01'
			AND public.offer_search_v1.sort_by = 'quality'
			AND public.offer_search_click_v1.event_name = 'guest_click_offer'
GROUP BY		public.offer_search_v1.search_id,
				public.offer_search_v1.guest_id,
				public.offer_search_v1.tracking_id,
				public.upl_touches_v1.device,
				public.upl_touches_v1.device_model,
				public.offer_search_v1.country,
				public.offer_search_v1.city,
				public.offer_search_v1.sort_by,
				DATE(TIMESTAMP 'epoch' + public.offer_search_v1.created_at/1000 * INTERVAL '1 second'),
				public.offer_search_v1.experiment_id
