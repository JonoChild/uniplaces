CREATE VIEW business_intelligence.upl_bookings_info AS

SELECT 			DISTINCT(public.upl_actions_v1.extra_info),
				    reporting.booking_old.guest_id as user_id,
				    public.upl_actions_v1.touch_id,
				    public.upl_actions_v1.action,
				    reporting.booking_old.current_state,
				    reporting.booking_old.offer_id,
				    reporting.booking_old.offer_exclusive,
				    reporting.booking_old.guest_purpose_of_stay,
				    reporting.booking_old.requested_at,
				    reporting.booking_old.accepted_at,
				    reporting.booking_old.rejected_at,
				    reporting.booking_old.paid_at,
				    reporting.booking_old.expired_at,
				    reporting.booking_old.cancelled_at,
				    reporting.booking_old.confirmed_at,
				    business_intelligence.touches_overall_view.source,
				    business_intelligence.source_classification.top_line_grouping,
				    business_intelligence.source_classification.cost_grouping,
				    business_intelligence.touches_overall_view.medium,
				    business_intelligence.touches_overall_view.campaign,
				    business_intelligence.touches_overall_view.camp_name,
				    business_intelligence.touches_overall_view.gclid,
				    SUM(reporting.transactions.money_value)/100 as net_revenue
FROM 			  public.upl_actions_v1
LEFT JOIN		reporting.booking_old ON reporting.booking_old.id = public.upl_actions_v1.extra_info
LEFT JOIN		business_intelligence.touches_overall_view ON business_intelligence.touches_overall_view.touch_id =public.upl_actions_v1.touch_id 	
LEFT JOIN		reporting.transactions ON reporting.transactions.booking_id = public.upl_actions_v1.extra_info
LEFT JOIN		business_intelligence.source_classification
					ON business_intelligence.source_classification.upl_source = business_intelligence.touches_overall_view.source
WHERE			  DATE(public.upl_actions_v1.created_at) >= '2018-09-18'
			  AND public.upl_actions_v1.action = 'booking-request'
GROUP BY		public.upl_actions_v1.extra_info,
				  reporting.booking_old.guest_id,
				  public.upl_actions_v1.touch_id,
				  public.upl_actions_v1.action,
				  reporting.booking_old.current_state,
				  reporting.booking_old.offer_id,
				  reporting.booking_old.offer_exclusive,
				  reporting.booking_old.guest_purpose_of_stay,
				  reporting.booking_old.requested_at,
				  reporting.booking_old.accepted_at,
				  reporting.booking_old.rejected_at,
				  reporting.booking_old.paid_at,
				  reporting.booking_old.expired_at,
				  reporting.booking_old.cancelled_at,
				  reporting.booking_old.confirmed_at,
				  business_intelligence.touches_overall_view.source,
				  business_intelligence.source_classification.top_line_grouping,
				  business_intelligence.source_classification.cost_grouping,
				  business_intelligence.touches_overall_view.medium,
				  business_intelligence.touches_overall_view.campaign,
				  business_intelligence.touches_overall_view.camp_name,
				  business_intelligence.touches_overall_view.gclid;
